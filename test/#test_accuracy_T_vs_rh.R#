#install_git("https://github.com/jmigueldelgado/micrometeo.git")
require(micrometeo)
require(plyr)
require(data.table)
require("xts")
require("dplyr")

f1 <- list("COMBILOG29","COMBILOG28","COMBILOG26","COMBILOG25","COMBILOG23","COMBILOG22","COMBILOG21","COMBILOG20","COMBILOG18")

readCOMBILOG_HS <- function(f)
{
    
    x <- read.table(paste0("~/GEOECOLOGY/user/delgado/EVAP_PT/HS/",f,".LOG"),header=FALSE,skip=8,sep="\t")
    h <- readLines(paste0("~/GEOECOLOGY/user/delgado/EVAP_PT/HS/",f,".LOG"),n=6)[6]
    h <- unlist(strsplit(h,split="\t"))
    h <- make.names(h)
    colnames(x) <- h
    x <- x[!is.na(names(x))]
    tt <- as.POSIXct(x$TimeDate,format="%m/%d/%Y %I:%M:%S %p",tz="Portugal")
    xx <- cbind(data.frame(time=tt),x[,c(-1,-2)])
    
    x <- read.table(paste0("~/GEOECOLOGY/user/delgado/EVAP_PT/HS/",f,"_S.LOG"),header=FALSE,skip=8,sep="\t")
    h <- readLines(paste0("~/GEOECOLOGY/user/delgado/EVAP_PT/HS/",f,"_S.LOG"),n=6)[6]
    h <- unlist(strsplit(h,split="\t"))
    h <- make.names(h)
    colnames(x) <- h
    x <- x[!is.na(names(x))]
    tt <- as.POSIXct(x$TimeDate,format="%m/%d/%Y %I:%M:%S %p",tz="Portugal")
    xx_S <- cbind(data.frame(time=tt),x[,c(-1,-2)])
    
    dat <- inner_join(xx,xx_S,by="time")
    
    
    return(dat)
}

ll <- lapply(f1,readCOMBILOG_HS)

df <- rbindlist(ll)
df <- df[with(df,order(time)),]
setkey(df,"time")
df2 <- unique(df,by="time")

df2 <- rename(df2,Soil.Temp_tmp=Soil.Temp3) %>% rename(Soil.Temp3=Soil.Temp2,Soil.Temp2=Soil.Temp_tmp)


ev1 <- wetbulb2vpressure(df2$Temp.Wet.BOTTOM,df2$Temp.Dry.BOTTOM,p_coruche()) #hPa
ev2 <- wetbulb2vpressure(df2$Temp.Wet.TOP,df2$Temp.Dry.TOP,p_coruche()) #hPa

q1 <- Q(ev1,p_coruche())
q2 <- Q(ev2,p_coruche())

rh1 <- specific_hum2rh(q1,df2$Temp.Dry.BOTTOM,p_coruche())
rh2 <- specific_hum2rh(q2,df2$Temp.Dry.TOP,p_coruche())


### test the sensitivity of ET to errors in rh

## select a period with et data 
i <- rh2<0.7
df3 <- tail(df2[i,],100)

Tdry <- df3$Temp.Dry.TOP
Twet <- df3$Temp.Wet.TOP

## calc rh
ev <- wetbulb2vpressure(Twet,Tdry,p_coruche()) #hPa

q <- Q(ev,p_coruche())

rh <- specific_hum2rh(q,Tdry,p_coruche())


k <- 70 #midday in february 2017

p <- p_coruche()
k <- 1
er <- data.frame(accuracy_multiplier=seq(-2,2,0.1),T=Tdry[k],err_T=abs(wetbulb2vpressure(Twet[k]+seq(-0.2,0.2,0.01),Tdry[k],p)-wetbulb2vpressure(Twet[k],Tdry[k],p)),err_rh=abs(rh2vpressure(rh[k]+seq(-0.02,0.02,0.001),Tdry[k])-rh2vpressure(rh[k],Tdry[k])))

for(k in seq(10,100,10))
{
    er <- rbind(er,data.frame(accuracy_multiplier=seq(-2,2,0.1),T=Tdry[k],err_T=abs(wetbulb2vpressure(Twet[k]+seq(-0.2,0.2,0.01),Tdry[k],p)-wetbulb2vpressure(Twet[k],Tdry[k],p)),err_rh=abs(rh2vpressure(rh[k]+seq(-0.02,0.02,0.001),Tdry[k])-rh2vpressure(rh[k],Tdry[k]))))
}

er <- rename(er,`error in observed T`=err_T,`error in observed rh`=err_rh)

err <- melt(er,id.vars=c("accuracy_multiplier","T"),measure.vars=c("error in observed T","error in observed rh"),value.name="error in ev [kPa]")
t <- round(err$T,1)
err$T <- factor(paste0("T=",t," degree C"))

require(ggplot2)
ggplot(err) + geom_line(aes(x=accuracy_multiplier,y=`error in ev [kPa]`,color=variable)) + facet_wrap(~T) + ggtitle("Difference in Vapour Pressure obtained by imposing an error\n scaled on sensor accuracy to\nobservations of T (0.1 degree C) and rh (1%)")

ggsave("./Terror_vs_rherror.png")
